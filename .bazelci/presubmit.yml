---
buildifier:
  version: 7.1.0

matrix:
  bazel: ["8.x"]
  platform:
    [
      "windows",
      "ubuntu2004",
      "rbe_ubuntu2204",
      "macos",
      "macos_arm64",
      "ubuntu2004_arm64",
      "windows_arm64",
    ]
  flag_combo:
    [
      ["--@rules_dotnet//dotnet/settings:strict_deps=true"],
      ["--@rules_dotnet//dotnet/settings:strict_deps=false"],
    ]
  e2e_working_directory: ["e2e/net8.0", "e2e/net9.0", "e2e/net10.0", "e2e/web_sdk"]

tasks:
  test_all:
    name: Build and test
    bazel: ${{ bazel }}
    platform: ${{ platform }}
    working_directory: ""
    include_json_profile:
      - build
      - test
    build_targets:
      - "//..."
    test_targets:
      - "//..."
    build_flags: ${{ flag_combo }}
    test_flags: ${{ flag_combo }}
  examples:
    name: Build and test
    bazel: ${{ bazel }}
    platform: ${{ platform }}
    working_directory: "examples"
    include_json_profile:
      - build
      - test
    build_targets:
      - "//..."
    test_targets:
      - "//..."
    build_flags: ${{ flag_combo }}
    test_flags: ${{ flag_combo }}
  e2e:
    name: ${{ e2e_working_directory }}
    bazel: ${{ bazel }}
    platform: ${{ platform }}
    working_directory: ${{ e2e_working_directory }}
    include_json_profile:
      - build
      - test
    build_targets:
      - "//..."
    test_targets:
      - "//..."
